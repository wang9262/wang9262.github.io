<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"/><meta name="og:site_name" content="Vong"/><link rel="canonical" href="https://wang9262.github.io/posts/Xcode-Condition-Build"/><meta name="twitter:url" content="https://wang9262.github.io/posts/Xcode-Condition-Build"/><meta name="og:url" content="https://wang9262.github.io/posts/Xcode-Condition-Build"/><title>iOS 中资源的条件编译 | Vong</title><meta name="twitter:title" content="iOS 中资源的条件编译 | Vong"/><meta name="og:title" content="iOS 中资源的条件编译 | Vong"/><meta name="description" content="Vong,iOS,Performance,性能,Swift,SwiftUI,Objective-C"/><meta name="twitter:description" content="Vong,iOS,Performance,性能,Swift,SwiftUI,Objective-C"/><meta name="og:description" content="Vong,iOS,Performance,性能,Swift,SwiftUI,Objective-C"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@Vong_HUST"/><meta name="twitter:creator" content="@Vong_HUST"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to Vong"/><meta name="twitter:image" content="https://wang9262.github.io/media"/><meta name="og:image" content="https://wang9262.github.io/media"/><script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script></head><body class="item-page"><header><div class="wrapper"><div class="logo"><a href="/"><h2>Vong</h2></a></div><div><div class="headerIcons"><a class="icon headIconWeixin"><script>    var weixinHeadButton = $('.headIconWeixin');
    weixinHeadButton.hover(
    function(){
    $('.weixinHeadQcode').css('display','block');
    },
    function(){
    $('.weixinHeadQcode').css('display','none');
    })</script></a><a class="icon headIconTwitter" href="https://www.twitter.com/Vong_HUST" target="_blank" rel="noreferrer"></a><a class="icon headIconEmail" href="mailto:Vong9262@gmail.com" target="_blank" rel="noreferrer"></a><a class="icon headIconGithub" href="https://github.com/wang9262/" target="_blank" rel="noreferrer"></a><a class="icon headIconRss" href="/feed.rss" target="_blank" rel="noreferrer"></a></div></div><nav><ul><li><a href="/">首页</a></li><li><a class="selected" href="/posts">所有文章</a></li><li><a href="/about">关于</a></li><li><a href="/tags">搜索</a></li></ul><div class="weixinHeadQcode" onclick="$('.weixinHeadQcode').css('display','none');"></div></nav></div></header><div class="container"><div class="wrapper"><div class="viewContainer"><div class="side-nav"><div class="sidebar"></div></div><div class="leftContent"><div class="post-actions"><div class="actionButton"><div class="actionButton twitter" onclick="window.open('https://twitter.com/intent/tweet?text=iOS 中资源的条件编译&url=https://wang9262.github.io/posts/Xcode-Condition-Build&via=Vong_HUST','target','');"></div></div><div class="actionButton"><div class="actionButton comment" onclick="$('html,body').animate({scrollTop: $('#gitalk-container').offset().top }, {duration: 500,easing:'swing'})"></div></div><div class="actionButton"><div class="actionButton top" onclick="$('html,body').animate({scrollTop: 0 }, {duration: 500,easing:'swing'})"></div></div></div><article><div><h1>iOS 中资源的条件编译</h1></div><div><ul class="tag-list"><li class="tag variant-4"><a href="/tags/xcode">Xcode</a></li><li class="tag tagdate">发布于2020年11月21日</li></ul><div class="content"><p>日常开发中常常遇到某些类及其引用的资源文件仅在 <code>Debug</code> 或内测版本中生效，而不希望带到线上版本。因为一来会增加包体积，二来会把一些内部功能的相关接口暴露，导致可能的一些动态调试。那么有没有避免的方案呢？</p><h2>Pod</h2><p>答案肯定是有的，通常的做法是把对应功能抽成单独的 <code>pod</code> 库，然后仅 <code>Debug</code> 模式才集成到主工程，发出去的版本不集成。通常方式如下，以 <code>FLEX</code> 为例：</p><pre data-language="ruby"><code>pod <span class="hljs-string">'FLEX'</span>, <span class="hljs-string">'~&gt; 2.0'</span>, <span class="hljs-symbol">:configurations</span> =&gt; [<span class="hljs-string">'Debug'</span>]
</code></pre><p>但是如果某些强耦合主工程无法拆成独立 <code>pod</code> 的功能，这种方式可能就不再适用了。</p><h2>条件编译</h2><p><code>pod</code> 这条路走不通，有没有其他方式呢？答案也是肯定的，也是大家经常采用的方式，使用条件编译。也就是将对应类文件及引用到的地方使用类似下面的方式：</p><pre data-language="undefined"><code>
#if DEBUG
// 放入仅Debug模式下生效的代码
#endif
</code></pre><p>以上两种方式将大部分场景 <code>cover</code> 住了，但是假设对应的类文件还引用到了图片、<code>Storyboard</code>、<code>Xib</code> 等资源时，该如何让这些资源仅在 <code>Debug</code> 下才参与编译，而其他场景不参与编译呢？</p><h2>Xcode Build Options</h2><p>既然都写了这篇文章了，那答案也是肯定的，就是使用 <code>Xcode</code> 提供的一个编译选项 <code>Excluded Source File Names</code> 来将不需要的资源排除。</p><img src="/media/2020-03-30/15855806858197.jpg"/><blockquote><p>确切来说这个编译选项是 <code>Xcode 9</code> 才引入的，之前版本需要自行定义，可以参考这个<a href="https://stackoverflow.com/a/41495430" target="_blank">回答</a>。 摘录一段来自<a href="https://xcodebuildsettings.com/#excluded_source_file_names" target="_blank">Xcode Build Settings</a>的解释 <img src="/media/2020-03-30/15855826179239.jpg" alt="-w849"/></p></blockquote><p>假设有下面目录结构的工程</p><pre data-language="undefined"><code>
# 使用 tree 命令行得到下面结构
├── ConditionBuildDemo
│   ├── A
│   │   ├── Debug
│   │   │   ├── DebugA.swift
│   │   │   ├── icon_test@2x.png
│   │   │   ├── Sub
│   │   │   │   ├── DeepSub
│   │   │   │   │   └── DeepSubA.swift
│   │   │   │   ├── SubDebugA.swift
│   │   │   │   └── icon.png
│   │   │   └── SubA.xcassets
│   │   │       ├── Contents.json
│   │   │       └── logo.imageset
│   │   │           ├── Contents.json
│   │   │           └── logo@2x.png
│   │   └── ModelA.swift
│   ├── B
│   │   ├── Debug
│   │   │   └── DebugB.swift
│   │   └── ModelB.swift
</code></pre><pre data-language="Swift"><code><span class="hljs-comment">//测试代码</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">viewDidLoad</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.viewDidLoad()
    <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">ModelA</span>()
    <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">ModelB</span>()
    <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">DebugA</span>()
    <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">DebugB</span>()
    <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">SubDebugA</span>()
    <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">DeepSubA</span>()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">UIImage</span>.<span class="hljs-keyword">init</span>(named: <span class="hljs-string">"logo"</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"has logo"</span>)
    }
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">UIImage</span>.<span class="hljs-keyword">init</span>(named: <span class="hljs-string">"icon"</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"has icon"</span>)
    }
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-number">_</span> = <span class="hljs-type">UIImage</span>.<span class="hljs-keyword">init</span>(named: <span class="hljs-string">"icon_test"</span>) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"has icon_test"</span>)
    }
}
</code></pre><blockquote><p>这里为了方便验证，直接设置 <code>Debug Configuration</code> 下的 <code>Excluded Source File Names</code>。如图 <img src="/media/2020-04-04/15859854120322.jpg" alt="-w984"/> 实际用到项目中可根据自己项目自行对不同 <code>Configuratio</code> 进行配置。</p></blockquote><p>下面我们来探索下这个路径的配置规则。</p><p>如果我们想要排除 <code>A</code> 和 <code>B</code> 目录下的 <code>Debug</code> 文件夹的所有内容，按照常规思路，理所当然直接写上 <code>Debug/*</code>，然后编译发现上面的测试代码编译报错，找不到类 <code>DebugA</code>,<code>DebugB</code>。</p><pre data-language="undefined"><code>
ViewController.swift:18:22: Use of unresolved identifier 'DebugA'
ViewController.swift:19:22: Use of unresolved identifier 'DebugB'
</code></pre><p>屏蔽掉这两处代码运行，发现 <code>has logo</code> 和 <code>has icon</code> 都输出了。</p><p>所以 <code>Debug/*</code> 只能屏蔽 <code>Debug</code> 根目录下的文件，子文件夹无法屏蔽（因为 <code>.xcasset</code> 实质上也是一个文件夹，所以无法被屏蔽）。</p><p>如果确实想要屏蔽 <code>Debug</code> 下所有内容，要怎么处理呢？目前我还没找到比较好的方式😂，只能一个个目录排除了。拿上面的的结构来说，如果要排除文件夹 <code>A</code> <code>B</code> 目录下的 <code>Debug</code>，可能就得这样配置 <code>Debug/*</code> <code>Debug/*/*</code> <code>Debug/*/*/*</code>，如图</p><img src="/media/2020-04-04/15859945623293.jpg" alt="-w589"/><p>所以这里支持的匹配模式主要有以下两种：</p><ul><li>文件名完全匹配，比如 <code>ModelA.Swift</code></li><li>通配符，如 <code>Debug/*.Swift</code> <code>Debug/*.*</code> <code>*/Debug/*</code> <code>Debug/*/*/*.png</code></li></ul><h2>Development Assets</h2><img src="/media/2020-04-04/15859936373369.jpg" alt="-w1219"/><blockquote><p>关于这个配置项可以查看 <a href="https://developer.apple.com/videos/play/wwdc2019/233/" target="_blank">WWDC 2019 Session 233 Mastering Xcode Previews</a></p></blockquote><p><code>Xcode 11</code> 新增了一个 <code>Development Assets</code> 的配置项，简单尝试了下，但是似乎没有生效。我把上面目录结构中的 <code>SubA.xcassets</code> 加到里面，然后用<code>release</code> 模式跑起来还是能读到对应的图片，不知道是不是姿势不对。</p><p>其实重点还是 <code>Excluded Source File Names</code> 这个编译配置，有时候会有事半功倍的效果。</p></div><div class="license">本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC 4.0许可协议</a>。转载请注明出处和作者。</div></div></article><div class="supporter"><p>关注微信公共号<a href="/about/">Vong</a>或在微博上关注<a href="https://weibo.com/VongLo">@Vong_HUST</a>，永远不会错过新内容！ 您的<a href="/about/">支持和鼓励</a>将为我的博客写作增添更多的动力!</p><img src="/images/weixincode.png"/><div class="label">动态更新</div></div><div class="item-navigator"><table><tr><td class="previous-item"><a href="/posts/Blog-based-on-Publish">基于 Publish 搭建博客</a></td><td class="next-item"><a href="/posts/An-Abnormal-Swift-Crash">聊聊最近遇到的一个Crash</a></td></tr></table></div><div id="gitalk-container"></div>    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script src="/Script/gitalk.js"></script></div><script src="/Script/toc.js"></script></div></div><footer><p>Copyright &copy; Vong 2022 </p><p>Generated using <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a></p><ul class="icon"><li><a href="https://twitter.com/Vong_HUST" target="_blank"><img class="twitter" src="/images/twitter.svg"/></a></li><li><a href="https://github.com/wang9262/" target="_blank"><img src="/images/github.svg"/></a></li><li><a href="/feed.rss"><img src="/images/rss.svg"/></a></li></ul><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZHSZ71NFYK"></script><script src="/Script/google_analyse.js"></script><script src="/Script/baidu_analyse.js"></script></footer></div></body></html>